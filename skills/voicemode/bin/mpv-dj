#!/usr/bin/env bash
# mpv-dj - Control background music during VoiceMode sessions
#
# Usage:
#   mpv-dj play <file|url> [--chapters <file>]  Start playback
#   mpv-dj mfp <episode>                         Play Music For Programming episode
#   mpv-dj status                                Show current track info
#   mpv-dj pause                                 Pause playback
#   mpv-dj resume                                Resume playback
#   mpv-dj next                                  Skip to next chapter
#   mpv-dj prev                                  Go to previous chapter
#   mpv-dj volume <0-100>                        Set volume
#   mpv-dj stop                                  Stop playback
#   mpv-dj raw <json-command>                    Send raw IPC command
#   mpv-dj history                               Show play history
#   mpv-dj favorite [add|list|remove]            Manage favorites

set -e

SOCKET="/tmp/voicemode-mpv.sock"
MFP_BASE_URL="https://datashat.net"
CHAPTERS_DIR="${HOME}/.voicemode/chapters"
DATA_DIR="${HOME}/.voicemode/dj"
HISTORY_FILE="${DATA_DIR}/history.json"
FAVORITES_FILE="${DATA_DIR}/favorites.json"

# Ensure data directory exists
init_data_dir() {
    mkdir -p "$DATA_DIR"
    [[ -f "$HISTORY_FILE" ]] || echo '[]' > "$HISTORY_FILE"
    [[ -f "$FAVORITES_FILE" ]] || echo '[]' > "$FAVORITES_FILE"
}

# Check if mpv is installed
check_mpv() {
    if ! command -v mpv &> /dev/null; then
        echo "Error: mpv is not installed. Install with: brew install mpv"
        exit 1
    fi
}

# Check if socat is installed (for IPC)
check_socat() {
    if ! command -v socat &> /dev/null; then
        echo "Error: socat is not installed. Install with: brew install socat"
        exit 1
    fi
}

# Check if mpv is running with our socket
is_running() {
    [ -S "$SOCKET" ] && echo '{"command": ["get_property", "pid"]}' | socat - "$SOCKET" 2>/dev/null | grep -q '"error":"success"'
}

# Send IPC command and get response
send_cmd() {
    if ! is_running; then
        echo "Error: DJ is not running. Start with: mpv-dj play <file>"
        exit 1
    fi
    echo "$1" | socat - "$SOCKET"
}

# Start mpv with IPC socket
cmd_play() {
    check_mpv

    local source=""
    local chapters_file=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --chapters)
                chapters_file="$2"
                shift 2
                ;;
            *)
                source="$1"
                shift
                ;;
        esac
    done

    if [[ -z "$source" ]]; then
        echo "Usage: mpv-dj play <file|url> [--chapters <file>]"
        exit 1
    fi

    # Stop existing playback
    if is_running; then
        send_cmd '{"command": ["quit"]}' > /dev/null 2>&1 || true
        sleep 0.5
    fi

    # Build mpv command
    local mpv_args=(
        --no-video
        --input-ipc-server="$SOCKET"
    )

    if [[ -n "$chapters_file" && -f "$chapters_file" ]]; then
        mpv_args+=(--chapters-file="$chapters_file")
    fi

    # Start mpv in background
    mpv "${mpv_args[@]}" "$source" &> /dev/null &

    echo "Started playback: $source"
    if [[ -n "$chapters_file" ]]; then
        echo "Chapters loaded from: $chapters_file"
    fi
}

# Play Music For Programming episode
cmd_mfp() {
    local episode="$1"

    if [[ -z "$episode" ]]; then
        echo "Usage: mpv-dj mfp <episode-number>"
        exit 1
    fi

    # Get the correct URL from RSS feed via helper script
    local helper_script="$(dirname "$0")/mfp-rss-helper"
    local stream_url

    if [[ ! -x "$helper_script" ]]; then
        echo "Error: mfp-rss-helper not found at $helper_script"
        exit 1
    fi

    stream_url=$("$helper_script" "$episode")
    if [[ $? -ne 0 ]]; then
        echo "Error: Failed to get URL for episode $episode"
        echo "$stream_url"
        exit 1
    fi

    # Check for local chapters file
    local chapters_file="${CHAPTERS_DIR}/mfp_${episode}.txt"

    mkdir -p "$CHAPTERS_DIR"

    # Record in history
    record_history "mfp" "$episode" "$stream_url"

    if [[ -f "$chapters_file" ]]; then
        cmd_play "$stream_url" --chapters "$chapters_file"
    else
        echo "Note: No chapters file found at $chapters_file"
        echo "Playing without chapter metadata..."
        cmd_play "$stream_url"
    fi
}

# Record play event in history
record_history() {
    init_data_dir
    local type="$1"
    local identifier="$2"
    local source="$3"
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    # Use Python for JSON manipulation (more reliable than jq dependency)
    python3 << PYTHON
import json
from pathlib import Path

history_file = Path("$HISTORY_FILE")
history = json.loads(history_file.read_text())

# Add new entry
entry = {
    "type": "$type",
    "identifier": "$identifier",
    "source": "$source",
    "timestamp": "$timestamp"
}
history.append(entry)

# Keep last 100 entries
history = history[-100:]

history_file.write_text(json.dumps(history, indent=2))
PYTHON
}

# Show play history
cmd_history() {
    init_data_dir
    local limit="${1:-10}"

    if [[ ! -s "$HISTORY_FILE" ]] || [[ $(cat "$HISTORY_FILE") == "[]" ]]; then
        echo "No play history yet"
        exit 0
    fi

    echo "Play History (last $limit):"
    echo "=========================="

    python3 << PYTHON
import json
from pathlib import Path
from datetime import datetime

history_file = Path("$HISTORY_FILE")
history = json.loads(history_file.read_text())

# Show most recent first
for entry in reversed(history[-$limit:]):
    ts = entry.get("timestamp", "")
    if ts:
        dt = datetime.fromisoformat(ts.replace("Z", "+00:00"))
        ts_str = dt.strftime("%Y-%m-%d %H:%M")
    else:
        ts_str = "unknown"

    entry_type = entry.get("type", "unknown")
    identifier = entry.get("identifier", "")

    if entry_type == "mfp":
        print(f"  {ts_str}  MFP Episode {identifier}")
    else:
        print(f"  {ts_str}  {entry.get('source', 'unknown')}")
PYTHON
}

# Manage favorites
cmd_favorite() {
    init_data_dir
    local action="${1:-list}"

    case "$action" in
        add)
            add_favorite
            ;;
        list)
            list_favorites
            ;;
        remove)
            remove_favorite "$2"
            ;;
        *)
            echo "Usage: mpv-dj favorite [add|list|remove <index>]"
            exit 1
            ;;
    esac
}

# Add current track to favorites
add_favorite() {
    if ! is_running; then
        echo "Error: DJ is not running. Play something first."
        exit 1
    fi

    # Get current track info
    local chapter_meta=$(send_cmd '{"command": ["get_property", "chapter-metadata"]}')
    local time_pos=$(send_cmd '{"command": ["get_property", "time-pos"]}')
    local path=$(send_cmd '{"command": ["get_property", "path"]}')

    local title=$(echo "$chapter_meta" | grep -o '"TITLE":"[^"]*"' | cut -d'"' -f4)
    local pos=$(echo "$time_pos" | grep -o '"data":[0-9.]*' | cut -d':' -f2)
    local source=$(echo "$path" | grep -o '"data":"[^"]*"' | cut -d'"' -f4)

    if [[ -z "$title" ]]; then
        title="Unknown track"
    fi

    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    python3 << PYTHON
import json
from pathlib import Path

favorites_file = Path("$FAVORITES_FILE")
favorites = json.loads(favorites_file.read_text())

# Add new favorite
entry = {
    "title": "$title",
    "source": "$source",
    "position": $pos,
    "added": "$timestamp"
}
favorites.append(entry)

favorites_file.write_text(json.dumps(favorites, indent=2))
print(f"Added to favorites: $title")
PYTHON
}

# List favorites
list_favorites() {
    if [[ ! -s "$FAVORITES_FILE" ]] || [[ $(cat "$FAVORITES_FILE") == "[]" ]]; then
        echo "No favorites yet. Use 'mpv-dj favorite add' while playing a track."
        exit 0
    fi

    echo "Favorites:"
    echo "=========="

    python3 << PYTHON
import json
from pathlib import Path

favorites_file = Path("$FAVORITES_FILE")
favorites = json.loads(favorites_file.read_text())

for i, fav in enumerate(favorites, 1):
    title = fav.get("title", "Unknown")
    pos = fav.get("position", 0)
    pos_min = int(pos) // 60
    pos_sec = int(pos) % 60
    print(f"  [{i}] {title} (at {pos_min}:{pos_sec:02d})")
PYTHON
}

# Remove favorite by index
remove_favorite() {
    local index="$1"
    if [[ -z "$index" ]]; then
        echo "Usage: mpv-dj favorite remove <index>"
        exit 1
    fi

    python3 << PYTHON
import json
from pathlib import Path

favorites_file = Path("$FAVORITES_FILE")
favorites = json.loads(favorites_file.read_text())

try:
    idx = int("$index") - 1
    if 0 <= idx < len(favorites):
        removed = favorites.pop(idx)
        favorites_file.write_text(json.dumps(favorites, indent=2))
        print(f"Removed: {removed.get('title', 'Unknown')}")
    else:
        print(f"Invalid index: $index")
except ValueError:
    print(f"Invalid index: $index")
PYTHON
}

# Get current status
cmd_status() {
    check_socat

    if ! is_running; then
        echo "DJ is not running"
        exit 0
    fi

    local chapter_meta=$(send_cmd '{"command": ["get_property", "chapter-metadata"]}')
    local time_pos=$(send_cmd '{"command": ["get_property", "time-pos"]}')
    local duration=$(send_cmd '{"command": ["get_property", "duration"]}')
    local volume=$(send_cmd '{"command": ["get_property", "volume"]}')
    local paused=$(send_cmd '{"command": ["get_property", "pause"]}')

    # Parse JSON responses
    local title=$(echo "$chapter_meta" | grep -o '"TITLE":"[^"]*"' | cut -d'"' -f4)
    local pos=$(echo "$time_pos" | grep -o '"data":[0-9.]*' | cut -d':' -f2)
    local dur=$(echo "$duration" | grep -o '"data":[0-9.]*' | cut -d':' -f2)
    local vol=$(echo "$volume" | grep -o '"data":[0-9.]*' | cut -d':' -f2)
    local is_paused=$(echo "$paused" | grep -o '"data":true')

    echo "DJ Status"
    echo "========="
    if [[ -n "$title" ]]; then
        echo "Track: $title"
    else
        echo "Track: (no chapter metadata)"
    fi

    if [[ -n "$pos" && -n "$dur" ]]; then
        # Convert to integers for time formatting
        local pos_int=${pos%.*}
        local dur_int=${dur%.*}
        local pos_min=$((pos_int / 60))
        local pos_sec=$((pos_int % 60))
        local dur_min=$((dur_int / 60))
        local dur_sec=$((dur_int % 60))
        printf "Position: %d:%02d / %d:%02d\n" "$pos_min" "$pos_sec" "$dur_min" "$dur_sec"
    fi

    if [[ -n "$vol" ]]; then
        echo "Volume: ${vol%.*}%"
    fi

    if [[ -n "$is_paused" ]]; then
        echo "State: Paused"
    else
        echo "State: Playing"
    fi
}

# Pause playback
cmd_pause() {
    send_cmd '{"command": ["set_property", "pause", true]}' > /dev/null
    echo "Paused"
}

# Resume playback
cmd_resume() {
    send_cmd '{"command": ["set_property", "pause", false]}' > /dev/null
    echo "Resumed"
}

# Next chapter
cmd_next() {
    send_cmd '{"command": ["add", "chapter", 1]}' > /dev/null
    sleep 0.3
    cmd_status
}

# Previous chapter
cmd_prev() {
    send_cmd '{"command": ["add", "chapter", -1]}' > /dev/null
    sleep 0.3
    cmd_status
}

# Set volume
cmd_volume() {
    local vol="$1"
    if [[ -z "$vol" ]] || [[ ! "$vol" =~ ^[0-9]+$ ]] || [[ "$vol" -lt 0 ]] || [[ "$vol" -gt 100 ]]; then
        echo "Usage: mpv-dj volume <0-100>"
        exit 1
    fi
    send_cmd "{\"command\": [\"set_property\", \"volume\", $vol]}" > /dev/null
    echo "Volume set to ${vol}%"
}

# Stop playback
cmd_stop() {
    if is_running; then
        send_cmd '{"command": ["quit"]}' > /dev/null 2>&1 || true
        echo "Stopped"
    else
        echo "DJ is not running"
    fi
}

# Raw IPC command
cmd_raw() {
    check_socat
    local cmd="$1"
    if [[ -z "$cmd" ]]; then
        echo "Usage: mpv-dj raw '<json-command>'"
        exit 1
    fi
    send_cmd "$cmd"
}

# Main command dispatch
case "${1:-}" in
    play)
        shift
        cmd_play "$@"
        ;;
    mfp)
        cmd_mfp "$2"
        ;;
    status)
        cmd_status
        ;;
    pause)
        cmd_pause
        ;;
    resume)
        cmd_resume
        ;;
    next)
        cmd_next
        ;;
    prev)
        cmd_prev
        ;;
    volume)
        cmd_volume "$2"
        ;;
    stop)
        cmd_stop
        ;;
    raw)
        cmd_raw "$2"
        ;;
    history)
        cmd_history "$2"
        ;;
    favorite)
        shift
        cmd_favorite "$@"
        ;;
    library)
        # Delegate to mpv-dj-library script
        shift
        exec "$(dirname "$0")/mpv-dj-library" "$@"
        ;;
    *)
        echo "mpv-dj - Background music for VoiceMode sessions"
        echo ""
        echo "Usage:"
        echo "  mpv-dj play <file|url> [--chapters <file>]  Start playback"
        echo "  mpv-dj mfp <episode>                         Play Music For Programming"
        echo "  mpv-dj status                                Show current track"
        echo "  mpv-dj pause                                 Pause playback"
        echo "  mpv-dj resume                                Resume playback"
        echo "  mpv-dj next                                  Next chapter"
        echo "  mpv-dj prev                                  Previous chapter"
        echo "  mpv-dj volume <0-100>                        Set volume"
        echo "  mpv-dj stop                                  Stop playback"
        echo "  mpv-dj history [limit]                       Show play history"
        echo "  mpv-dj favorite [add|list|remove <idx>]      Manage favorites"
        echo "  mpv-dj library <command>                     Music library (scan, search, play)"
        echo "  mpv-dj raw '<json>'                          Send raw IPC command"
        ;;
esac
